"use strict";(()=>{var xr=Object.create;var Pe=Object.defineProperty;var Ar=Object.getOwnPropertyDescriptor;var yr=Object.getOwnPropertyNames;var hr=Object.getPrototypeOf,br=Object.prototype.hasOwnProperty;var z=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports);var vr=(e,r,t,a)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of yr(r))!br.call(e,n)&&n!==t&&Pe(e,n,{get:()=>r[n],enumerable:!(a=Ar(r,n))||a.enumerable});return e};var le=(e,r,t)=>(t=e!=null?xr(hr(e)):{},vr(r||!e||!e.__esModule?Pe(t,"default",{value:e,enumerable:!0}):t,e));var pe=z((ue,ke)=>{(function(e,r){if(typeof define=="function"&&define.amd)define("webextension-polyfill",["module"],r);else if(typeof ue<"u")r(ke);else{var t={exports:{}};r(t),e.browser=t.exports}})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:ue,function(e){"use strict";if(!globalThis.chrome?.runtime?.id)throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){let r="The message port closed before a response was received.",t=a=>{let n={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(n).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class u extends WeakMap{constructor(s,f=void 0){super(f),this.createItem=s}get(s){return this.has(s)||this.set(s,this.createItem(s)),super.get(s)}}let m=o=>o&&typeof o=="object"&&typeof o.then=="function",c=(o,s)=>(...f)=>{a.runtime.lastError?o.reject(new Error(a.runtime.lastError.message)):s.singleCallbackArg||f.length<=1&&s.singleCallbackArg!==!1?o.resolve(f[0]):o.resolve(f)},x=o=>o==1?"argument":"arguments",h=(o,s)=>function(l,...A){if(A.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${x(s.minArgs)} for ${o}(), got ${A.length}`);if(A.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${x(s.maxArgs)} for ${o}(), got ${A.length}`);return new Promise((T,S)=>{if(s.fallbackToNoCallback)try{l[o](...A,c({resolve:T,reject:S},s))}catch(i){console.warn(`${o} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,i),l[o](...A),s.fallbackToNoCallback=!1,s.noCallback=!0,T()}else s.noCallback?(l[o](...A),T()):l[o](...A,c({resolve:T,reject:S},s))})},P=(o,s,f)=>new Proxy(s,{apply(l,A,T){return f.call(A,o,...T)}}),k=Function.call.bind(Object.prototype.hasOwnProperty),v=(o,s={},f={})=>{let l=Object.create(null),A={has(S,i){return i in o||i in l},get(S,i,C){if(i in l)return l[i];if(!(i in o))return;let g=o[i];if(typeof g=="function")if(typeof s[i]=="function")g=P(o,o[i],s[i]);else if(k(f,i)){let U=h(i,f[i]);g=P(o,o[i],U)}else g=g.bind(o);else if(typeof g=="object"&&g!==null&&(k(s,i)||k(f,i)))g=v(g,s[i],f[i]);else if(k(f,"*"))g=v(g,s[i],f["*"]);else return Object.defineProperty(l,i,{configurable:!0,enumerable:!0,get(){return o[i]},set(U){o[i]=U}}),g;return l[i]=g,g},set(S,i,C,g){return i in l?l[i]=C:o[i]=C,!0},defineProperty(S,i,C){return Reflect.defineProperty(l,i,C)},deleteProperty(S,i){return Reflect.deleteProperty(l,i)}},T=Object.create(o);return new Proxy(T,A)},d=o=>({addListener(s,f,...l){s.addListener(o.get(f),...l)},hasListener(s,f){return s.hasListener(o.get(f))},removeListener(s,f){s.removeListener(o.get(f))}}),M=new u(o=>typeof o!="function"?o:function(f){let l=v(f,{},{getContent:{minArgs:0,maxArgs:0}});o(l)}),j=new u(o=>typeof o!="function"?o:function(f,l,A){let T=!1,S,i=new Promise(L=>{S=function(I){T=!0,L(I)}}),C;try{C=o(f,l,S)}catch(L){C=Promise.reject(L)}let g=C!==!0&&m(C);if(C!==!0&&!g&&!T)return!1;let U=L=>{L.then(I=>{A(I)},I=>{let me;I&&(I instanceof Error||typeof I.message=="string")?me=I.message:me="An unexpected error occurred",A({__mozWebExtensionPolyfillReject__:!0,message:me})}).catch(I=>{console.error("Failed to send onMessage rejected reply",I)})};return U(g?C:i),!0}),E=({reject:o,resolve:s},f)=>{a.runtime.lastError?a.runtime.lastError.message===r?s():o(new Error(a.runtime.lastError.message)):f&&f.__mozWebExtensionPolyfillReject__?o(new Error(f.message)):s(f)},w=(o,s,f,...l)=>{if(l.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${x(s.minArgs)} for ${o}(), got ${l.length}`);if(l.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${x(s.maxArgs)} for ${o}(), got ${l.length}`);return new Promise((A,T)=>{let S=E.bind(null,{resolve:A,reject:T});l.push(S),f.sendMessage(...l)})},O={devtools:{network:{onRequestFinished:d(M)}},runtime:{onMessage:d(j),onMessageExternal:d(j),sendMessage:w.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:w.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},G={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return n.privacy={network:{"*":G},services:{"*":G},websites:{"*":G}},v(a,O,n)};e.exports=t(chrome)}else e.exports=globalThis.browser})});var sr=z((xs,ar)=>{"use strict";ar.exports=()=>{let e={};return e.promise=new Promise((r,t)=>{e.resolve=r,e.reject=t}),e}});var ir=z((As,nr)=>{"use strict";var co=sr();function xo(e,r="maxAge"){let t,a,n,u=async()=>{if(t!==void 0)return;let x=async h=>{n=co();let P=h[1][r]-Date.now();if(P<=0){e.delete(h[0]),n.resolve();return}return t=h[0],a=setTimeout(()=>{e.delete(h[0]),n&&n.resolve()},P),typeof a.unref=="function"&&a.unref(),n.promise};try{for(let h of e)await x(h)}catch{}t=void 0},m=()=>{t=void 0,a!==void 0&&(clearTimeout(a),a=void 0),n!==void 0&&(n.reject(void 0),n=void 0)},c=e.set.bind(e);return e.set=(x,h)=>{e.has(x)&&e.delete(x);let P=c(x,h);return t&&t===x&&m(),u(),P},u(),e}nr.exports=xo});var mr=z((ys,fr)=>{"use strict";var Ao=ir(),ye=class{constructor(r,t){if(this.maxAge=r,this[Symbol.toStringTag]="Map",this.data=new Map,Ao(this.data),t)for(let[a,n]of t)this.set(a,n)}get size(){return this.data.size}clear(){this.data.clear()}delete(r){return this.data.delete(r)}has(r){return this.data.has(r)}get(r){let t=this.data.get(r);if(t)return t.data}set(r,t){return this.data.set(r,{maxAge:Date.now()+this.maxAge,data:t}),this}values(){return this.createIterator(r=>r[1].data)}keys(){return this.data.keys()}entries(){return this.createIterator(r=>[r[0],r[1].data])}forEach(r,t){for(let[a,n]of this.entries())r.apply(t,[n,a,this])}[Symbol.iterator](){return this.entries()}*createIterator(r){for(let t of this.data.entries())yield r(t)}};fr.exports=ye});var W=le(pe());var wr=typeof global=="object"&&global&&global.Object===Object&&global,V=wr;var Tr=typeof self=="object"&&self&&self.Object===Object&&self,Pr=V||Tr||Function("return this")(),b=Pr;var kr=b.Symbol,F=kr;var je=Object.prototype,jr=je.hasOwnProperty,Sr=je.toString,$=F?F.toStringTag:void 0;function Cr(e){var r=jr.call(e,$),t=e[$];try{e[$]=void 0;var a=!0}catch{}var n=Sr.call(e);return a&&(r?e[$]=t:delete e[$]),n}var Se=Cr;var Er=Object.prototype,Or=Er.toString;function Mr(e){return Or.call(e)}var Ce=Mr;var Ir="[object Null]",Nr="[object Undefined]",Ee=F?F.toStringTag:void 0;function Rr(e){return e==null?e===void 0?Nr:Ir:Ee&&Ee in Object(e)?Se(e):Ce(e)}var R=Rr;function Br(e){return e!=null&&typeof e=="object"}var _=Br;var Dr=Array.isArray,Oe=Dr;function Ur(e){var r=typeof e;return e!=null&&(r=="object"||r=="function")}var K=Ur;var Fr="[object AsyncFunction]",_r="[object Function]",Wr="[object GeneratorFunction]",Gr="[object Proxy]";function Lr(e){if(!K(e))return!1;var r=R(e);return r==_r||r==Wr||r==Fr||r==Gr}var J=Lr;var $r=b["__core-js_shared__"],H=$r;var Me=function(){var e=/[^.]+$/.exec(H&&H.keys&&H.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}();function qr(e){return!!Me&&Me in e}var Ie=qr;var zr=Function.prototype,Vr=zr.toString;function Kr(e){if(e!=null){try{return Vr.call(e)}catch{}try{return e+""}catch{}}return""}var B=Kr;var Jr=/[\\^$.*+?()[\]{}|]/g,Hr=/^\[object .+?Constructor\]$/,Zr=Function.prototype,Xr=Object.prototype,Qr=Zr.toString,Yr=Xr.hasOwnProperty,et=RegExp("^"+Qr.call(Yr).replace(Jr,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function rt(e){if(!K(e)||Ie(e))return!1;var r=J(e)?et:Hr;return r.test(B(e))}var Ne=rt;function tt(e,r){return e?.[r]}var Re=tt;function ot(e,r){var t=Re(e,r);return Ne(t)?t:void 0}var N=ot;var at=N(b,"WeakMap"),Z=at;var st=9007199254740991;function nt(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=st}var X=nt;function it(e){return e!=null&&X(e.length)&&!J(e)}var Be=it;var ft=Object.prototype;function mt(e){var r=e&&e.constructor,t=typeof r=="function"&&r.prototype||ft;return e===t}var Q=mt;var lt="[object Arguments]";function ut(e){return _(e)&&R(e)==lt}var de=ut;var De=Object.prototype,pt=De.hasOwnProperty,dt=De.propertyIsEnumerable,gt=de(function(){return arguments}())?de:function(e){return _(e)&&pt.call(e,"callee")&&!dt.call(e,"callee")},Ue=gt;function ct(){return!1}var Fe=ct;var Ge=typeof exports=="object"&&exports&&!exports.nodeType&&exports,_e=Ge&&typeof module=="object"&&module&&!module.nodeType&&module,xt=_e&&_e.exports===Ge,We=xt?b.Buffer:void 0,At=We?We.isBuffer:void 0,yt=At||Fe,Le=yt;var ht="[object Arguments]",bt="[object Array]",vt="[object Boolean]",wt="[object Date]",Tt="[object Error]",Pt="[object Function]",kt="[object Map]",jt="[object Number]",St="[object Object]",Ct="[object RegExp]",Et="[object Set]",Ot="[object String]",Mt="[object WeakMap]",It="[object ArrayBuffer]",Nt="[object DataView]",Rt="[object Float32Array]",Bt="[object Float64Array]",Dt="[object Int8Array]",Ut="[object Int16Array]",Ft="[object Int32Array]",_t="[object Uint8Array]",Wt="[object Uint8ClampedArray]",Gt="[object Uint16Array]",Lt="[object Uint32Array]",p={};p[Rt]=p[Bt]=p[Dt]=p[Ut]=p[Ft]=p[_t]=p[Wt]=p[Gt]=p[Lt]=!0;p[ht]=p[bt]=p[It]=p[vt]=p[Nt]=p[wt]=p[Tt]=p[Pt]=p[kt]=p[jt]=p[St]=p[Ct]=p[Et]=p[Ot]=p[Mt]=!1;function $t(e){return _(e)&&X(e.length)&&!!p[R(e)]}var $e=$t;function qt(e){return function(r){return e(r)}}var qe=qt;var ze=typeof exports=="object"&&exports&&!exports.nodeType&&exports,q=ze&&typeof module=="object"&&module&&!module.nodeType&&module,zt=q&&q.exports===ze,ge=zt&&V.process,Vt=function(){try{var e=q&&q.require&&q.require("util").types;return e||ge&&ge.binding&&ge.binding("util")}catch{}}(),ce=Vt;var Ve=ce&&ce.isTypedArray,Kt=Ve?qe(Ve):$e,Ke=Kt;function Jt(e,r){return function(t){return e(r(t))}}var Je=Jt;var Ht=Je(Object.keys,Object),He=Ht;var Zt=Object.prototype,Xt=Zt.hasOwnProperty;function Qt(e){if(!Q(e))return He(e);var r=[];for(var t in Object(e))Xt.call(e,t)&&t!="constructor"&&r.push(t);return r}var Ze=Qt;var Yt=N(b,"Map"),Y=Yt;var eo=N(b,"DataView"),ee=eo;var ro=N(b,"Promise"),re=ro;var to=N(b,"Set"),te=to;var Xe="[object Map]",oo="[object Object]",Qe="[object Promise]",Ye="[object Set]",er="[object WeakMap]",rr="[object DataView]",ao=B(ee),so=B(Y),no=B(re),io=B(te),fo=B(Z),D=R;(ee&&D(new ee(new ArrayBuffer(1)))!=rr||Y&&D(new Y)!=Xe||re&&D(re.resolve())!=Qe||te&&D(new te)!=Ye||Z&&D(new Z)!=er)&&(D=function(e){var r=R(e),t=r==oo?e.constructor:void 0,a=t?B(t):"";if(a)switch(a){case ao:return rr;case so:return Xe;case no:return Qe;case io:return Ye;case fo:return er}return r});var tr=D;var mo="[object Map]",lo="[object Set]",uo=Object.prototype,po=uo.hasOwnProperty;function go(e){if(e==null)return!0;if(Be(e)&&(Oe(e)||typeof e=="string"||typeof e.splice=="function"||Le(e)||Ke(e)||Ue(e)))return!e.length;var r=tr(e);if(r==mo||r==lo)return!e.size;if(Q(e))return!Ze(e).length;for(var t in e)if(po.call(e,t))return!1;return!0}var xe=go;var Ae=le(pe());async function or(){let{provider:e="chatgpt"}=await Ae.default.storage.local.get("provider"),r="provider:gpt3",t=await Ae.default.storage.local.get(r);return{provider:e,configs:{["gpt3"]:t[r]}}}var gr=le(mr());var oe,yo=new Uint8Array(16);function he(){if(!oe&&(oe=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!oe))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return oe(yo)}var y=[];for(let e=0;e<256;++e)y.push((e+256).toString(16).slice(1));function lr(e,r=0){return(y[e[r+0]]+y[e[r+1]]+y[e[r+2]]+y[e[r+3]]+"-"+y[e[r+4]]+y[e[r+5]]+"-"+y[e[r+6]]+y[e[r+7]]+"-"+y[e[r+8]]+y[e[r+9]]+"-"+y[e[r+10]]+y[e[r+11]]+y[e[r+12]]+y[e[r+13]]+y[e[r+14]]+y[e[r+15]]).toLowerCase()}var ho=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),be={randomUUID:ho};function bo(e,r,t){if(be.randomUUID&&!r&&!e)return be.randomUUID();e=e||{};let a=e.random||(e.rng||he)();if(a[6]=a[6]&15|64,a[8]=a[8]&63|128,r){t=t||0;for(let n=0;n<16;++n)r[t+n]=a[n];return r}return lr(a)}var ae=bo;function ur(e){let r,t,a,n,u,m,c;return x(),{feed:h,reset:x};function x(){r=!0,t="",a=0,n=-1,u=void 0,m=void 0,c=""}function h(k){t=t?t+k:k,r&&vo(t)&&(t=t.slice(pr.length)),r=!1;let v=t.length,d=0,M=!1;for(;d<v;){M&&(t[d]===`
`&&++d,M=!1);let j=-1,E=n,w;for(let O=a;j<0&&O<v;++O)w=t[O],w===":"&&E<0?E=O-d:w==="\r"?(M=!0,j=O-d):w===`
`&&(j=O-d);if(j<0){a=v-d,n=E;break}else a=0,n=-1;P(t,d,E,j),d+=j+1}d===v?t="":d>0&&(t=t.slice(d))}function P(k,v,d,M){if(M===0){c.length>0&&(e({type:"event",id:u,event:m||void 0,data:c.slice(0,-1)}),c="",u=void 0),m=void 0;return}let j=d<0,E=k.slice(v,v+(j?M:d)),w=0;j?w=M:k[v+d+1]===" "?w=d+2:w=d+1;let O=v+w,G=M-w,o=k.slice(O,O+G).toString();if(E==="data")c+=o?"".concat(o,`
`):`
`;else if(E==="event")m=o;else if(E==="id"&&!o.includes("\0"))u=o;else if(E==="retry"){let s=parseInt(o,10);Number.isNaN(s)||e({type:"reconnect-interval",value:s})}}}var pr=[239,187,191];function vo(e){return pr.every((r,t)=>e.charCodeAt(t)===r)}async function*dr(e){let r=e.getReader();try{for(;;){let{done:t,value:a}=await r.read();if(t)return;yield a}}finally{r.releaseLock()}}async function se(e,r){let{onMessage:t,...a}=r,n=await fetch(e,a);if(!n.ok){let m=await n.json().catch(()=>({}));throw new Error(xe(m)?`${n.status} ${n.statusText}`:JSON.stringify(m))}let u=ur(m=>{m.type==="event"&&t(m.data)});for await(let m of dr(n.body)){let c=new TextDecoder().decode(m);u.feed(c)}}async function Te(e,r,t,a){return fetch(`https://chat.openai.com/backend-api${t}`,{method:r,headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:a===void 0?void 0:JSON.stringify(a)})}async function cr(e,r){await Te(e,"POST","/conversation/message_feedback",r)}async function wo(e,r,t){await Te(e,"PATCH",`/conversation/${r}`,t)}var ve="accessToken",we=new gr.default(10*1e3);async function ie(){if(we.get(ve))return we.get(ve);let e=await fetch("https://chat.openai.com/api/auth/session");if(e.status===403)throw new Error("CLOUDFLARE");let r=await e.json().catch(()=>({}));if(!r.accessToken)throw new Error("UNAUTHORIZED");return we.set(ve,r.accessToken),r.accessToken}var ne=class{constructor(r){this.token=r;this.token=r}async fetchModels(){return(await Te(this.token,"GET","/models").then(t=>t.json())).models}async getModelName(){try{return(await this.fetchModels())[0].slug}catch(r){return console.error(r),"text-davinci-002-render"}}async generateAnswer(r){let t,a=()=>{t&&wo(this.token,t,{is_visible:!1})},n=await this.getModelName();return await se("https://chat.openai.com/backend-api/conversation",{method:"POST",signal:r.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({action:"next",messages:[{id:ae(),role:"user",content:{content_type:"text",parts:[r.prompt]}}],model:n,parent_message_id:ae()}),onMessage(u){var x,h,P;if(console.debug("sse message",u),u==="[DONE]"){r.onEvent({type:"done"}),a();return}let m;try{m=JSON.parse(u)}catch(k){return}let c=(P=(h=(x=m.message)==null?void 0:x.content)==null?void 0:h.parts)==null?void 0:P[0];c&&(t=m.conversation_id,r.onEvent({type:"answer",data:{text:c,messageId:m.message.id,conversationId:m.conversation_id}}))}}),{cleanup:a}}};var fe=class{constructor(r,t){this.token=r;this.model=t;this.token=r,this.model=t}buildPrompt(r){return this.model.startsWith("text-chat-davinci")?`Respond conversationally.<|im_end|>

User: ${r}<|im_sep|>
ChatGPT:`:r}buildMessages(r){return[{role:"user",content:r}]}async generateAnswer(r){let t="";return await se("https://api.openai.com/v1/chat/completions",{method:"POST",signal:r.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({model:this.model,messages:this.buildMessages(r.prompt),stream:!0,max_tokens:800}),onMessage(a){if(console.debug("sse message",a),a==="[DONE]"){r.onEvent({type:"done"});return}let n;try{n=JSON.parse(a);let u=n.choices[0].delta.content;if(u===void 0||u==="<|im_end|>"||u==="<|im_sep|>")return;t+=u,r.onEvent({type:"answer",data:{text:t,messageId:n.id,conversationId:n.id}})}catch(u){return}}}),{}}};async function To(e,r){let t=await or(),a;if(t.provider==="chatgpt"){let m=await ie();a=new ne(m)}else if(t.provider==="gpt3"){let{apiKey:m,model:c}=t.configs["gpt3"];a=new fe(m,c)}else throw new Error(`Unknown provider ${t.provider}`);let n=new AbortController;e.onDisconnect.addListener(()=>{n.abort(),u==null||u()});let{cleanup:u}=await a.generateAnswer({prompt:r,signal:n.signal,onEvent(m){if(m.type==="done"){e.postMessage({event:"DONE"});return}e.postMessage(m.data)}})}W.default.runtime.onConnect.addListener(e=>{e.onMessage.addListener(async r=>{console.debug("received msg",r);try{await To(e,r.question)}catch(t){e.postMessage({error:t.message})}})});W.default.runtime.onMessage.addListener(async e=>{if(e.type==="FEEDBACK"){let r=await ie();await cr(r,e.data)}else if(e.type==="OPEN_OPTIONS_PAGE")W.default.runtime.openOptionsPage();else if(e.type==="GET_ACCESS_TOKEN")return ie()});W.default.runtime.onInstalled.addListener(e=>{e.reason==="install"&&W.default.runtime.openOptionsPage()});})();
